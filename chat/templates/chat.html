{% load staticfiles %}
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<link rel="icon" href="{% static 'img/logo.ico' %}" type="img/x-ico" />
<title>BatMan</title>
    {% block css %}
        <link rel="stylesheet" href="{% static 'dist/css/layui.css' %}" media="all">
    {% endblock %}
</head>
<body>
<button class="layui-btn site-demo-layim" data-type="addGroup">新建群聊</button>
<script type="text/javascript" src="http://cdn-hangzhou.goeasy.io/goeasy.js"></script>
{% block script %}
    <script src="{% static 'dist/layui.js' %}"></script>
	<script src="{% static 'js/utils.js' %}"></script>
	<script src="{% static 'js/socket.js'%}"></script>
{% endblock %}
<script>
layui.use(['layim', 'jquery'], function(layim){
	var $ = layui.jquery;
	var user_id = get_query_param('user_id');

    layim.config({

	    // 初始化接口
        init: {
        	// 接口地址
			url: '/chat/init/'
			// 默认get，一般可不填
	        ,type: 'get'
	        // 额外参数
			,data: {user_id: user_id}
        }
		// 查看群员接口
        ,members: {
          url: '/chat/init_group_chat/'
          ,data: {}
        }

        //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
        ,uploadImage: {
          url: '/chat/upload_image/'
        }

        //上传文件接口（返回的数据格式见下文），若不开启文件上传，剔除该项即可
        ,uploadFile: {
          url: '/chat/upload_file/'
        }

		,isAudio: true //开启聊天工具栏音频
		,isVideo: true //开启聊天工具栏视频

        //扩展工具栏（如果无需扩展，剔除该项即可）
        ,tool: [{
          alias: 'code' //工具别名
          ,title: '代码' //工具名称
          ,icon: '&#xe64e;' //工具图标，参考图标文档
        }]
	    // 是否简约模式（若开启则不显示主面板）
		,brief: false
	    // 自定义主面板最小化时的标题
	    ,title: 'WebIM'
		,right: '0px' //主面板相对浏览器右侧距离
	    ,minRight: '0px' //聊天面板最小化时相对浏览器右侧距离
	    ,initSkin: '3.jpg' //1-5 设置初始背景
	    // ,skin: ['aaa.jpg'] //新增皮肤
	    ,isfriend: true //是否开启好友
	    ,isgroup: true //是否开启群组
	    ,min: false //是否始终最小化主面板，默认false
	    ,notice: true //是否开启桌面消息提醒，默认false
	    ,voice: 'default.mp3' //声音提醒，默认开启，声音文件为：default.mp3

        ,msgbox: layui.cache.dir + 'css/modules/layim/html/msgbox.html' //消息盒子页面地址，若不开启，剔除该项即可

        ,find: layui.cache.dir + 'css/modules/layim/html/find.html?user_id='+ user_id//发现页面地址，若不开启，剔除该项即可

        ,chatLog: layui.cache.dir + 'css/modules/layim/html/chatlog.html' //聊天记录页面地址，若不开启，剔除该项即可
    });

    layim.on('sendMessage', function(res){
    	console.log(res);
	    $.ajax({
			url: '/chat/msg_gateway/',
			type: 'post',
			data: res,
			success: function(data){
				console.log(data)
			}
		})
    });
	// console.log(layim.cache().mine.id);
	//监听自定义工具栏点击，以添加代码为例
	layim.on('tool(code)', function(insert, send, obj){ //事件中的tool为固定字符，而code则为过滤器，对应的是工具别名（alias）
		layer.prompt(
			{
				title: '插入代码'
				,formType: 2
				,shade: 0
			},
			function(text, index)
			{
				layer.close(index);
				insert('[pre class=layui-code]' + text + '[/pre]'); //将内容插入到编辑器，主要由insert完成
				//send(); //自动发送
			});
		console.log(this); //获取当前工具的DOM对象
		console.log(obj); //获得当前会话窗口的DOM对象、基础信息
	});

	// 在群聊面板中查看全部成员时触发，该事件返回获取群员接口（即layim.config中的members）的response信息
	layim.on('members', function(data){
		console.log(data);
	});
	// 监听聊天窗口的切换
	layim.on('chatChange', function(obj){
		console.log('聊天切换');
		console.log(obj);
	});

	// 当你的WebSocket监听到有好友或者群新增时，需让LayIM的主面板同步添加的信息
	layim.on('ready', function(res){
		// 监听收到的聊天消息
		goEasy.subscribe({
			channel: user_id,
			onMessage: function(res){
				let content = JSON.parse(res.content);
				console.log(typeof content);
				console.log(content);
				if (content.type === 'msg'  && content.msg.fromid !== user_id){
					layim.getMessage(content.msg);
				}
				else if(content.type === 'addList'){
					// 添加好友/群到主面板
					layim.addList(content.msg);
				}
				else if(content.type === 'removeList'){
					// 从主面板移除好友/群
					layim.removeList({
						type: 'friend' //或者group
						,id: 1238668 //好友或者群组ID
					})
				}
			}
		});
		// 首先获取所有群聊的ID
		let groups = layim.cache().group;
		for (let i = 0; i < groups.length; i++) {
			goEasy.subscribe({
				channel: groups[i].id,
				onMessage: function(res){
					let content = JSON.parse(res.content);
					console.log(typeof content);
					console.log(content);
					if (content.type === 'msg' && content.msg.fromid !== user_id){

						console.log(content.msg);
						layim.getMessage(content.msg);
					}
				}
				,onSuccess: function () {
					console.log('订阅成功')
				}
				,onFailed: function (error) {
					layer.msg('订阅失败，错误编码：' + error.code + ' 错误信息：' + error.content, {icon: 2});
				}
			});
		}
	});

	// 用户修改签名
	layim.on('sign', function(value){
		console.log(value);
		$.ajax({
			url: '/chat/modify_sign/',
			type: 'post',
			data: {sign: value, id: user_id},
			success: function(data){
				// console.log(data);
				if (data.code === 0) {
					layer.msg('修改成功', {icon: 1});
				}
				else {
					layer.msg('修改失败', {icon: 2});
				}
			}
		})
	});

	// 监听在线状态切换
	layim.on('online', function(status){
		console.log(status); //获得online或者hide
		$.ajax({
			url: '/chat/modify_status/',
			type: 'post',
			data: {status: status, id: user_id},
			success: function(data){
				// console.log(data);
				if (data.code === 0) {
					layer.msg('修改成功', {icon: 1});
				}
				else {
					layer.msg('修改失败', {icon: 2});
				}
			}
		})
	});

	// 监听更换背景皮肤
	layim.on('setSkin', function(filename, src){
		console.log(filename); //获得文件名，如：1.jpg
		console.log(src); //获得背景路径，如：http://res.layui.com/layui/src/css/modules/layim/skin/1.jpg
	});

	// 监听该用户被添加为好友的消息，即好友申请消息
	goEasy.subscribe({
		channel: user_id + 'be_added_as_a_friend'
		,onMessage: function(res){
			let content = JSON.parse(res.content);
			console.log(typeof content);
			console.log(content);
			if (content.type === 'friend') {
				layim.setFriendGroup({
					type: 'friend'
					,username: content.msg.username //好友昵称，若申请加群，参数为：groupname
					,avatar: content.msg.avatar //头像
					,group: layim.cache().friend //获取好友列表数据
					,submit: function(group, index){
						$.ajax({
							url: '/chat/add_friend/',
							type: 'post',
							data: {
								res_type: 'pass',
								user_id: content.msg.from_user_id,
								friend_id: user_id,
								a_group_id: content.msg.to_group_id,
								b_group_id: group,
							},
							success: function(data){
								// 同意后，将好友追加到主面板
								layim.addList(data);
								// 关闭改面板
								layer.close(index);
							}
						});
					}
				});
			} else if (content.type === 'group') {
				layim.setFriendGroup({
					type: 'group'
					,groupname: 'xxx' //好友昵称，若申请加群，参数为：groupname
					,avatar: 'a.jpg' //头像
					,group: layim.cache().friend //获取好友列表数据
					,submit: function(group, index){
						//一般在此执行Ajax和WS，以通知对方已经同意申请
						//……

						//同意后，将好友追加到主面板
						layim.addList(data); //见下文
					}
				});
			}
		}
		,onSuccess: function () {
			console.log('订阅成功')
		}
		,onFailed: function (error) {
			layer.msg('订阅失败，错误编码：' + error.code + ' 错误信息：' + error.content, {icon: 2});
		}
	});

	// 监听当前用户好友申请通过的消息
	// 如果被拒绝也可以通知该用户
	goEasy.subscribe({
		channel: user_id + 'friend_result'
		,onMessage: function(res){
			console.log(typeof res);
			// let content = JSON.parse(res);
			let content = JSON.parse(res.content);
			console.log(content);
			if (content.type === 'pass') {
				layim.addList(content.msg);
				layer.msg('好友申请已通过')
			} else {
				layer.msg('好友申请被拒绝')
			}
		}
		,onSuccess: function () {
			console.log('订阅成功')
		}
		,onFailed: function (error) {
			layer.msg('订阅失败，错误编码：' + error.code + ' 错误信息：' + error.content, {icon: 2});
		}
	});

	// 面板外的操作
	var active = {
		// 添加群聊
		addGroup: function(){
			layer.prompt(function(val, index){
				// layer.msg('得到了'+val);
				$.ajax({
					url: '/chat/add_group/',
					type: 'post',
					data: {
						user_id: user_id,
						group_chat_name: val,
						// group_chat_avatar: '',
					},
					success: function (res) {
						console.log(typeof res);
						console.log(res);
						if (res.code !== 0){
							layer.msg(res.msg, {icon: 1});
						}
						// 增加一个群组
						layim.addList({
							type: 'group'
							,avatar: res.data.group_avatar
							,groupname: val
							,id: res.data.group_id
							,members: 1
						});
						layer.close(index);
						layer.msg('已成功把['+ val +']添加到群组里', {icon: 1});
					}
				});
			});
		}
		,removeFriend: function(){
		layer.msg('已成功删除[凤姐]', {
		icon: 1
		});
		//删除一个好友
		layim.removeList({
		id: 121286
		,type: 'friend'
		});
		}
		,removeGroup: function(){
			layer.msg('已成功删除[前端群]', {
				icon: 1
			});
			//删除一个群组
			layim.removeList({
				id: 101
				,type: 'group'
			});
		}
		//置灰离线好友
		,setGray: function(){
			layim.setFriendStatus(168168, 'offline');
				layer.msg('已成功将好友[马小云]置灰', {
				icon: 1
			});
		}
		//取消好友置灰
		,unGray: function(){
			layim.setFriendStatus(168168, 'online');
				layer.msg('成功取消好友[马小云]置灰状态', {
				icon: 1
			});
		}
	};
	$('.site-demo-layim').on('click', function(){
		var type = $(this).data('type');
		console.log(type);
		active[type] ? active[type].call(this) : '';
	});
});
</script>
</body>
</html>